
## Chapter 8: Advanced Features

### Generated Columns

```sql
CREATE TABLE IF NOT EXISTS summary_cases (
  state STRING,
  fips INT,
  cases INT,
  deaths INT,
  county STRING,
  year INT GENERATED ALWAYS AS (YEAR(date))
) USING DELTA
```

### Identity Columns

```sql
-- Generated by default (can override)
id BIGINT GENERATED BY DEFAULT AS IDENTITY

-- Generated always (cannot override)
id BIGINT GENERATED ALWAYS AS IDENTITY
```

**Notes:**
- Must use BIGINT type
- Cannot partition by identity column
- Concurrent transactions disallowed

### Comments

**Add at creation:**
```sql
CREATE TABLE example_table (
  id INT COMMENT 'uid column',
  content STRING COMMENT 'payload column for text'
) USING delta
```

**Update comment:**
```sql
ALTER TABLE example_table
ALTER COLUMN id
COMMENT 'unique id column'
```

**Transaction comments:**
```python
(spark
 .read
 .table(source)
 .write
 .format("delta")
 .option("path", destination)
 .option("userMetadata", "custom commit metadata")
 .save())
```

```sql
SET spark.databricks.delta.commitInfo.userMetadata='comment here';
```

### CHECK Constraints

**Add NOT NULL:**
```sql
CREATE TABLE IF NOT EXISTS example_table (
  id INT COMMENT 'uid column' NOT NULL,
  content STRING COMMENT 'payload column for text'
) USING delta
```

**Add CHECK constraint:**
```sql
ALTER TABLE example_table
ADD CONSTRAINT id CHECK (id > 0)
```

### Deletion Vectors (Merge-on-Read)

**Enable deletion vectors:**
```sql
ALTER TABLE tblName
SET TBLPROPERTIES ('delta.enableDeletionVectors' = true);
```

**Requirements:**
- Reader version ≥ 3
- Writer version ≥ 7
- Databricks Runtime ≥ 14 to write
- Databricks Runtime ≥ 12.1 to read

**Example:**
```python
# Delete single record
spark.sql("""
DELETE FROM nyt
WHERE county='Pinellas' AND date='2020-03-11'
""").show()
```

**File structure after deletion:**
```
table/
├── county=Pinellas/
│   └── part-00001-...parquet (original file)
├── deletion_vector_xxx.bin (new)
└── _delta_log/
    └── 00000000000000000002.json
```

**Multiple deletions compacted:**
- Delta Lake compacts deletion vectors for same partition
- Old deletion vectors become stale (removed by VACUUM)

---
